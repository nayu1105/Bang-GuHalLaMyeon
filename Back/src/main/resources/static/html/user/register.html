<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>회원가입</title>
    <link
      rel="stylesheet"
      as="style"
      crossorigin
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.5/dist/web/static/pretendard.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>

    <!-- JavaScript -->
    <script src="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/alertify.min.js"></script>

    <!-- CSS -->
    <link
      rel="stylesheet"
      href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/alertify.min.css"
    />
    <!-- Default theme -->
    <link
      rel="stylesheet"
      href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/themes/default.min.css"
    />
    <!-- Semantic UI theme -->
    <link
      rel="stylesheet"
      href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/themes/semantic.min.css"
    />
    <!-- Bootstrap theme -->
    <link
      rel="stylesheet"
      href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/themes/bootstrap.min.css"
    />

    <link rel="stylesheet" href="/css/register.css" type="text/css" />
    <link rel="stylesheet" href="/css/login.css" type="text/css" />
  </head>

  <body>
    <div id="container-fluid">
      <!--       <%-- nav bar --%> <%@ include file="./login.jsp"%> -->
      <div class="wrapper">
        <!-- nav PART start -->
        <div class="nav_part">
          <!-- nav start -->
          <nav class="navbar fixed-top navbar-expand navbar-dark bg-dark">
            <div class="container-fluid">
              <a class="navbar-brand" href="/html/index.html">🏠 구해줘 Home</a>
              <button
                class="navbar-toggler"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#navbarNavAltMarkup"
                aria-controls="navbarNavAltMarkup"
                aria-expanded="false"
                aria-label="Toggle navigation"
              >
                <span class="navbar-toggler-icon"></span>
              </button>
              <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                <div class="navbar-nav">
                  <a class="nav-link active" aria-current="page" href="/html/index.html">메인</a>
                  <a class="nav-link" href="/board">공지사항</a>
                  <a class="nav-link" href="/arround">주변 업종</a>
                  <a class="nav-link" href="/event" id="btnEventManage">이벤트 관리</a>
                </div>
              </div>
            </div>

            <!-- 메뉴 버튼 -->
            <button
              type="button"
              class="nav_btn btn btn-outline-light navLogin"
              data-bs-toggle="modal"
              data-bs-target="#exampleModal"
            >
              로그인
            </button>
            <button
              type="button"
              class="nav_btn btn btn-outline-light navLogout loginState"
              data-bs-toggle="modal"
              data-bs-target="#exampleModal2"
              id="btnLogout"
            >
              로그아웃
            </button>
            <button type="button" class="nav_btn btn btn-outline-light navSignup">
              <a href="/register">회원가입</a>
            </button>
            <button type="button" class="nav_btn btn btn-outline-light loginState navProfile">
              <a href="/html/user/profile.html">내 정보</a>
            </button>
            <button type="button" class="nav_btn btn btn-outline-light loginState navBookmark">
              <a href="/html/house/houseFavorite.html">북마크</a>
            </button>
          </nav>
          <!-- nav end -->
        </div>
        <!-- nav PART end -->

        <!-- Modal -->
        <div
          class="modal fade"
          id="exampleModal"
          tabindex="-1"
          aria-labelledby="exampleModalLabel"
          aria-hidden="true"
        >
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>
              <div class="modal-body">
                <div id="loginBox">
                  <form>
                    <div id="loginBtnBox">
                      <h2 id="login">로그인</h2>
                    </div>

                    <div class="mb-3">
                      <label for="loginEmail" class="form-label">아이디</label>
                      <input
                        type="email"
                        class="form-control"
                        id="loginEmail"
                        placeholder="이메일을 입력하세요."
                        aria-describedby="emailHelp"
                        value="admin@admin.com"
                        autocomplete="off"
                      />
                    </div>
                    <div class="mb-3">
                      <label for="loginPassword" class="form-label">비밀번호</label>
                      <input
                        type="password"
                        class="form-control"
                        id="loginPassword"
                        placeholder="비밀번호를 입력하세요."
                        value="1234"
                        autocomplete="off"
                      />
                    </div>
                    <div id="loginBtnBox">
                      <button
                        type="button"
                        class="btn btn-primary"
                        id="btnLogin"
                        data-bs-dismiss="modal"
                        aria-label="Close"
                      >
                        로그인
                      </button>
                    </div>
                    <br />
                    <div id="loginBtnBox">
                      <!--
                      <button type="submit" class="btnfind">아이디/비밀번호 찾기</button>
                      <div id="divInline">|</div> -->
                      <button type="submit" class="btnfind">
                        <a href="/register">회원가입</a>
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- logout Modal -->
        <div
          class="modal fade"
          id="exampleModal2"
          tabindex="-1"
          aria-labelledby="exampleModalLabel"
          aria-hidden="true"
        >
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">로그아웃 되었습니다.</h5>
              </div>
              <div class="modal-footer">
                <button
                  id="goMain"
                  type="button"
                  class="btn btn-primary gomain"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                >
                  메인으로 가기
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- sign up -->
      <div id="signupBox">
        <div id="signupTitle">
          <h2 id="signup">회원가입</h2>
        </div>
        <form class="row g-3">
          <div class="col-md-12">
            <label for="userName" class="form-label">이름 *</label>
            <input type="text" class="form-control" id="userName" autocomplete="off" />

            <div class="valid-feedback">Valid!</div>
            <div class="invalid-feedback">이름을 3글자 이상 입력하세요.</div>
          </div>
          <div class="col-md-12">
            <label for="userEmail" class="form-label">이메일 *</label>
            <input type="email" class="form-control" id="userEmail" autocomplete="off" />

            <div class="valid-feedback">Valid!</div>
            <div class="invalid-feedback">이메일 형식이 올바르지 않습니다.</div>
          </div>
          <div class="col-md-12">
            <label for="userPassword" class="form-label">비밀번호 *</label>
            <input
              type="password"
              class="form-control"
              id="userPassword"
              placeholder="특수문자, 영문, 숫자 포함 8자리 이상"
              autocomplete="off"
            />
            <div class="valid-feedback">Valid!</div>
            <div class="invalid-feedback">
              비밀번호를 입력하세요. (특수문자, 영문, 숫자 포함 8글자 이상)
            </div>
          </div>

          <div class="col-md-12">
            <label for="userPassword2" class="form-label">비밀번호 확인 *</label>
            <input
              type="password"
              class="form-control"
              id="userPassword2"
              placeholder="비밀번호를 다시 입력하세요."
              autocomplete="off"
            />
            <div class="valid-feedback">Valid!</div>
            <div class="invalid-feedback">비밀번호가 일치하지 않습니다.</div>
          </div>

          <!-- 회원 구분 라디오 버튼 -->
          <div id="radioGroup"></div>

          <div id="signupBtnBox">
            <div class="col-12">
              <button id="btnRegister" type="submit" class="btn btn-secondary">회원가입</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <script src="/js/util.js"></script>

    <script>
      let navLogout = document.querySelector(".navLogout");
      let navLogin = document.querySelector(".navLogin");
      let navProfile = document.querySelector(".navProfile");
      let navSignup = document.querySelector(".navSignup");
      let navBookmark = document.querySelector(".navBookmark");

      let user_code = sessionStorage.getItem("userCode");

      if (user_code != "null") {
        if (user_code == "001") {
          document.querySelector("#btnEventManage").style.display = "block";
        } else {
          document.querySelector("#btnEventManage").style.display = "none";
        }
      } else {
        document.querySelector("#btnEventManage").style.display = "none";
      }

      document.querySelector("#btnLogin").addEventListener("click", loginToggle);
      navLogout.addEventListener("click", logoutToggle);

      function loginToggle() {
        navLogout.classList.remove("loginState");
        navLogin.classList.add("loginState");

        navProfile.classList.remove("loginState");
        navSignup.classList.add("loginState");
      }

      function logoutToggle() {
        navLogout.classList.add("loginState");
        navLogin.classList.remove("loginState");

        navProfile.classList.add("loginState");
        navSignup.classList.remove("loginState");
      }

      if (user_code != null) {
        navLogout.classList.remove("loginState");
        navLogin.classList.add("loginState");

        navProfile.classList.remove("loginState");
        navBookmark.classList.remove("loginState");
        navSignup.classList.add("loginState");
      } else {
        navLogout.classList.add("loginState");
        navLogin.classList.remove("loginState");

        navProfile.classList.add("loginState");
        navBookmark.classList.add("loginState");
        navSignup.classList.remove("loginState");
      }
      /////////////////////

      window.onload = function () {
        document.querySelector("#btnLogin").onclick = function (e) {
          e.preventDefault();

          let userEmailValue = document.querySelector("#loginEmail").value;
          let userPasswordValue = document.querySelector("#loginPassword").value;
          console.log(userEmailValue, userPasswordValue);

          // 유효성 검사 => post 전송
          if (validate()) {
            // alert("valid");
            login();
          } else {
            // 유효성 검사 실패에 대한 UI 처리
            alertify.error("아이디 또는 패스워드를 확인하세요. ");
          }
        };

        codeList();

        document.querySelector("#userName").focus();
        document.querySelector("#userEmail");

        // 유효성 검사 처리
        document.querySelector("#userName").onblur = function () {
          if (validateUserName(this.value)) {
            // 유효
            this.classList.remove("is-invalid");
            this.classList.add("is-valid");
          } else {
            // 유효 X
            this.classList.remove("is-valid");
            this.classList.add("is-invalid");
          }
        };

        document.querySelector("#userPassword").onblur = function () {
          if (validatePassword(this.value)) {
            // 유효
            this.classList.remove("is-invalid");
            this.classList.add("is-valid");
          } else {
            // 유효 X
            this.classList.remove("is-valid");
            this.classList.add("is-invalid");
          }
        };

        document.querySelector("#userPassword2").onblur = function () {
          if (validatePassword2(this.value)) {
            // 유효
            this.classList.remove("is-invalid");
            this.classList.add("is-valid");
          } else {
            // 유효 X
            this.classList.remove("is-valid");
            this.classList.add("is-invalid");
          }
        };

        document.querySelector("#userEmail").onblur = function () {
          if (validateUserEmail(this.value)) {
            // 유효
            this.classList.remove("is-invalid");
            this.classList.add("is-valid");
          } else {
            // 유효 X
            this.classList.remove("is-valid");
            this.classList.add("is-invalid");
          }
        };
      };

      // 길이가 4 이상이면 valid
      function validateUserName(userName) {
        if (userName.length >= 3) return true;
        else return false;
      }

      // 비밀번호 유효성 검사
      function validatePassword(userPassword) {
        var patternEngAtListOne = new RegExp(/[a-zA-Z]+/); // + for at least one
        var patternSpeAtListOne = new RegExp(/[~!@#$%^&*()_+|<>?:{}]+/); // + for at least one
        var patternNumAtListOne = new RegExp(/[0-9]+/); // + for at least one

        if (
          patternEngAtListOne.test(userPassword) &&
          patternSpeAtListOne.test(userPassword) &&
          patternNumAtListOne.test(userPassword) &&
          userPassword.length >= 8
        ) {
          return true;
        } else return false;
      }

      function validatePassword2(userPassword2) {
        if (userPassword2 == document.querySelector("#userPassword").value) return true;
        else return false;
      }

      function validateUserEmail(userEmail) {
        // ^ 시작일치, $ 끝 일치
        // {2, 3} 2개 ~ 3개
        // * 0회 이상, + 1회 이상
        // [-_.] - 또는 _ 또는 .
        // ? 없거나 1회
        let regexp =
          /^[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*.[a-zA-Z]{2,3}$/i;
        if (regexp.test(userEmail)) return true;
        else return false;
      }

      document.querySelector("#btnRegister").onclick = function (e) {
        e.preventDefault();

        let userNameValue = document.querySelector("#userName").value;
        let userPasswordValue = document.querySelector("#userPassword").value;
        let userEmailValue = document.querySelector("#userEmail").value;

        if (document.querySelectorAll("form .is-invalid").length > 0) {
          alert("입력이 올바르지 않습니다. ");
        } else {
          register();
        }
      };

      async function register() {
        let userNameValue = document.querySelector("#userName").value;
        let userPasswordValue = document.querySelector("#userPassword").value;
        let userEmailValue = document.querySelector("#userEmail").value;
        let userCode = "";

        const nodeList = document.getElementsByName("codeR");
        nodeList.forEach((node) => {
          if (node.checked) {
            userCode = node.value;
          }
        });

        // parameter
        let urlParams = new URLSearchParams({
          userName: userNameValue,
          userPassword: userPasswordValue,
          userEmail: userEmailValue,
          code: userCode,
        });

        // fetch options
        let fetchOptions = {
          method: "POST",
          body: urlParams,
        };

        let response = await fetch("/register", fetchOptions);
        let data = await response.json();
        if (data.result == "success") {
          alertify.alert(
            "Welcome!",
            "회원가입을 축하합니다. 메인 페이지로 이동합니다. ",
            function () {
              window.location.href = "/html/index.html";
            }
          );
        } else if (data.result == "fail") {
          alert("서버 오류!");
        }
      }

      async function codeList() {
        // fetch options
        let fetchOptions = {
          method: "GET",
          headers: {
            async: "true",
          },
        };

        let url = "/register/getcommon/001";

        try {
          let res = await fetch(url, fetchOptions);
          let data = await res.json();
          console.log(data);
          makeList(data);
        } catch (err) {
          console.log(err);
          alertify.error("공통코드를 가져오는데 문제가 생겼습니다.");
        }
      }

      function makeList(list) {
        let listHtml = ``;

        for (var el in list) {
          listHtml += `<label class="radioBtn"><input type="radio" autocomplete="off" name="codeR" value="${list[el][0].code}">${list[el][0].codeName}</label>`;
          listHtml += `<label class="radioBtn"><input type="radio" autocomplete="off" name="codeR" value="${list[el][1].code}">${list[el][1].codeName}</label>`;
        }

        document.querySelector("#radioGroup").innerHTML = listHtml;
      }

      // logout
      document.querySelector("#btnLogout").onclick = function (e) {
        e.preventDefault();
        logout();
      };

      document.querySelector("#goMain").onclick = function (e) {
        e.preventDefault();
        // 메인 주소 넣기
        window.location.reload();
      };

      function validate() {
        // return true / false
        let isUserEmailValid = false;
        let isUserPasswordValid = false;

        let userEmailValue = document.querySelector("#loginEmail").value;
        if (userEmailValue.length > 0) {
          isUserEmailValid = true;
        }

        let userPasswordValue = document.querySelector("#loginPassword").value;
        if (userPasswordValue.length > 0) {
          isUserPasswordValid = true;
        }

        if (isUserEmailValid && isUserPasswordValid) {
          return true;
        }

        return false;
      }

      async function login() {
        // validate() 가 true를 return 하면 수행
        // 백엔드로 전송한 데이터(파라미터) 준비
        // 비동기로 요청
        // POST
        // 로그인 성공 => 게시판 메인 페이지로 이동 (/board/boardMain)
        // 로그인 실패 => alert 띄우기

        let userEmail = document.querySelector("#loginEmail").value;
        let userPassword = document.querySelector("#loginPassword").value;

        // parameter
        let urlParams = new URLSearchParams({
          userEmail: userEmail,
          userPassword: userPassword,
        });

        // fetch options
        let fetchOptions = {
          method: "POST",
          body: urlParams,
        };

        // fetch(url, option)
        let response = await fetch("/login", fetchOptions);
        let data = await response.json(); // json => javascript object <= JSON.parse()
        if (data.result == "success") {
          // server로 부터 받은 사용자 정보를 저장/사용
          sessionStorage.setItem("userName", data.userName);
          sessionStorage.setItem("userProfileImageUrl", data.userProfileImageUrl);
          sessionStorage.setItem("userCode", data.userCode);
          sessionStorage.setItem("userSeq", data.userSeq);

          alertify.success("로그인 되었습니다!");
          setTimeout(() => window.location.reload(), 700);
        } else if (data.result == "fail") {
          alertify.error("아이디 또는 패스워드를 확인하세요. ");
        }
      }

      async function logout() {
        // sessionStorage 초기화
        destroyUserInfo();

        let url = "/logout";

        try {
          let response = await fetch(url);
          let data = await response.json(); // json => javascript object <= JSON.parse()
          if (data.result == "success") {
            window.location.href = "/";
          } else if (data.result == "fail") {
            alertify.error("로그아웃 과정에서 오류가 발생했습니다. ");
          }
        } catch (error) {
          alertify.error("로그아웃 과정에서 오류가 발생했습니다. ");
        }
      }
    </script>
  </body>
</html>
