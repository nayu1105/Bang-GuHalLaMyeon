<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>실거래가 조회 메인</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>

    <!-- JavaScript -->
    <script src="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/alertify.min.js"></script>

    <!-- CSS -->
    <link
      rel="stylesheet"
      href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/alertify.min.css"
    />
    <!-- Default theme -->
    <link
      rel="stylesheet"
      href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/themes/default.min.css"
    />
    <!-- Semantic UI theme -->
    <link
      rel="stylesheet"
      href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/themes/semantic.min.css"
    />
    <!-- Bootstrap theme -->
    <link
      rel="stylesheet"
      href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/themes/bootstrap.min.css"
    />
    <link rel="stylesheet" href="/css/login.css" type="text/css" />

    <style>
      #topContainer {
        margin-top: 150px;
      }

      .page-link {
        color: #000;
        background-color: #fff;
        border: 1px solid #ccc;
      }

      .page-item.active .page-link {
        z-index: 1;
        color: white;
        font-weight: bold;
        background-color: #212529 !important;
        border-color: #212529 !important;
      }

      .page-link:focus,
      .page-link:hover {
        color: #000;
        background-color: #fafafa;
        border-color: #ccc;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid p-0">
      <div class="wrapper">
        <!-- nav PART start -->
        <div class="nav_part">
          <!-- nav start -->
          <nav class="navbar fixed-top navbar-expand navbar-dark bg-dark">
            <div class="container-fluid">
              <a class="navbar-brand" href="/html/index.html">🏠 구해줘 Home</a>
              <button
                class="navbar-toggler"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#navbarNavAltMarkup"
                aria-controls="navbarNavAltMarkup"
                aria-expanded="false"
                aria-label="Toggle navigation"
              >
                <span class="navbar-toggler-icon"></span>
              </button>
              <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                <div class="navbar-nav">
                  <a class="nav-link active" aria-current="page" href="/html/index.html">메인</a>
                  <a class="nav-link" href="/board">공지사항</a>
                  <a class="nav-link" href="/arround">주변 업종</a>
                  <a class="nav-link" href="/event" id="btnEventManage">이벤트 관리</a>
                </div>
              </div>
            </div>

            <!-- 메뉴 버튼 -->
            <button
              type="button"
              class="nav_btn btn btn-outline-light navLogin"
              data-bs-toggle="modal"
              data-bs-target="#exampleModal"
            >
              로그인
            </button>
            <button
              type="button"
              class="nav_btn btn btn-outline-light navLogout loginState"
              data-bs-toggle="modal"
              data-bs-target="#exampleModal2"
              id="btnLogout"
            >
              로그아웃
            </button>
            <button type="button" class="nav_btn btn btn-outline-light navSignup">
              <a href="/html/register.html">회원가입</a>
            </button>
            <button type="button" class="nav_btn btn btn-outline-light loginState navProfile">
              <a href="/html/user/profile.html">내 정보</a>
            </button>
            <button type="button" class="nav_btn btn btn-outline-light loginState navBookmark">
              <a href="/html/house/houseFavorite.html">북마크</a>
            </button>
          </nav>
          <!-- nav end -->
        </div>
        <!-- nav PART end -->

        <!-- Modal -->
        <div
          class="modal fade"
          id="exampleModal"
          tabindex="-1"
          aria-labelledby="exampleModalLabel"
          aria-hidden="true"
        >
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>
              <div class="modal-body">
                <div id="loginBox">
                  <form>
                    <div id="loginBtnBox">
                      <h2 id="login">로그인</h2>
                    </div>

                    <div class="mb-3">
                      <label for="loginEmail" class="form-label">아이디</label>
                      <input
                        type="email"
                        class="form-control"
                        id="loginEmail"
                        placeholder="이메일을 입력하세요."
                        aria-describedby="emailHelp"
                        value="admin@admin.com"
                        autocomplete="off"
                      />
                    </div>
                    <div class="mb-3">
                      <label for="loginPassword" class="form-label">비밀번호</label>
                      <input
                        type="password"
                        class="form-control"
                        id="loginPassword"
                        placeholder="비밀번호를 입력하세요."
                        value="1234"
                        autocomplete="off"
                      />
                    </div>
                    <div id="loginBtnBox">
                      <button
                        type="button"
                        class="btn btn-primary"
                        id="btnLogin"
                        data-bs-dismiss="modal"
                        aria-label="Close"
                      >
                        로그인
                      </button>
                    </div>
                    <br />
                    <div id="loginBtnBox">
                      <!--
                      <button type="submit" class="btnfind">아이디/비밀번호 찾기</button>
                      <div id="divInline">|</div> -->
                      <button type="submit" class="btnfind">
                        <a href="/html/register.html">회원가입</a>
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- logout Modal -->
        <div
          class="modal fade"
          id="exampleModal2"
          tabindex="-1"
          aria-labelledby="exampleModalLabel"
          aria-hidden="true"
        >
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">로그아웃 되었습니다.</h5>
              </div>
              <div class="modal-footer">
                <button
                  id="goMain"
                  type="button"
                  class="btn btn-primary gomain"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                >
                  메인으로 가기
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- footer start -->
        <!--
        <footer>
          <ul class="footer-list p-0 m-0">
            <li><a href="#">개인정보 처리방침</a></li>
            <li><a href="#">이용 약관</a></li>
            <li><a href="#">오시는 길</a></li>
            <li>&copy; SSAFY 9조 반유진 염정아</li>
          </ul>
        </footer> -->
        <!-- footer end -->
      </div>
    </div>
    <div id="topContainer" class="container">
      <!-- 		<%-- nav bar --%> <%@ include file="../login.jsp"%> -->
      <h4 class="text-center mt-4">실거래가 조회</h4>

      <!-- 검색 -->
      <div class="input-group mb-3 mt-4">
        <select class="form-select" id="sido" aria-label="Default select example">
          <option selected value="">전체</option>
          <option value="서울특별시" selected>서울특별시</option>
        </select>
        <select class="form-select" id="gugun" aria-label="Default select example">
          <option value="">전체</option>
          <option value="종로구" selected>종로구</option>
        </select>
      </div>

      <div class="input-group mb-3">
        <select class="form-select" id="searchCategory" aria-label="Default select example">
          <option selected value="아파트별">아파트별</option>
          <option value="동별">동별</option>
        </select>
        <input
          class="form-control"
          type="text"
          id="searchWord"
          placeholder="검색어를 입력하세요"
          aria-label="default input example"
        />
        <button class="btn btn-dark" type="button" id="btnHouseSearch">조회</button>
      </div>

      <!-- 테이블 -->
      <table class="table table-hover">
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">시구</th>
            <th scope="col">구군</th>
            <th scope="col">동</th>
            <th scope="col">아파트명</th>
            <th scope="col">층</th>
            <th scope="col">면적</th>
            <th scope="col">거래금액</th>
          </tr>
        </thead>
        <tbody id="aptTbody"></tbody>
      </table>

      <!-- 페이지네이션 -->
      <nav id="paginationWrapper" class="mt-4"></nav>

      <!-- Board Detail Modal -->
      <div
        class="modal fade"
        id="houseDetailModal"
        tabindex="-1"
        aria-labelledby="exampleModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">아파트 상세조회</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <table class="table table-hover" style="cursor: default">
                <tbody>
                  <tr>
                    <td>글 번호</td>
                    <td id="houseSeqDetail">#</td>
                  </tr>
                  <tr>
                    <td>시도</td>
                    <td id="sidoDetail">#</td>
                  </tr>
                  <tr>
                    <td>구군</td>
                    <td id="gugunDetail">#</td>
                  </tr>
                  <tr>
                    <td>동</td>
                    <td id="dongDetail">#</td>
                  </tr>
                  <tr>
                    <td>아파트명</td>
                    <td id="aptNameDetail">#</td>
                  </tr>
                  <tr>
                    <td>층</td>
                    <td id="floorDetail">#</td>
                  </tr>
                  <tr>
                    <td>면적</td>
                    <td id="areaDetail">#</td>
                  </tr>
                  <tr>
                    <td>거래금액</td>
                    <td id="dealAmountDetail">#</td>
                  </tr>
                  <tr>
                    <td>개설연도</td>
                    <td id="buildYearDetail">#</td>
                  </tr>
                  <tr>
                    <td>거래연도</td>
                    <td id="dealYearDetail">#</td>
                  </tr>
                  <tr>
                    <td>거래월</td>
                    <td id="dealMonthDetail">#</td>
                  </tr>
                </tbody>
              </table>

              <button id="btnHouseFavorite" type="button" class="btn btn-dark">북마크</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="/js/util.js"></script>
    <script>
      var OFFSET = 0; // offset
      var SEARCH_WORD = ""; // 검색어

      // Pagination
      var LIST_ROW_COUNT = 10; // limit, 한 페이지 내에 보여주는 글의 개수
      var PAGE_LINK_COUNT = 10; // 페이지 링크를 몇 개 만들 것인가. 그 밑에 10개 이렇게 있는거
      var CURRENT_PAGE_INDEX = 1; // 현재 페이지 인덱스
      var TOTAL_LIST_ITEM_COUNT = 0; // 총 아이템 건 수

      var SUCCESS = 1;

      window.onload = () => {
        houseList();

        document.querySelector("#gugun").onchange = () => {
          houseList();
        };

        document.querySelector("#btnHouseSearch").onclick = () => {
          houseSearch();
        };

        document.querySelector("#btnHouseFavorite").onclick = (e) => {
          let houseSeq = e.path[1].querySelector("#houseSeqDetail").innerHTML;
          houseFavorite(houseSeq);
        };
      };

      async function houseFavorite(houseSeq) {
        let url = "/favorite/favoriteInsert";
        let urlParams = "?houseSeq=" + houseSeq;

        let fetchOptions = {
          method: "GET",
        };

        try {
          let res = await fetch(url + urlParams, fetchOptions);
          let data = await res.json();

          if (data.result == "success") {
            alertify.success("북마크 되었습니다.");
            setTimeout(() => {
              window.location.href = "/favorite/favoriteMain";
            }, 800);
          } else if (data.result == "fail") {
            alertify.error(
              "북마크 과정에 실패했습니다. <br> 북마크는 최대 10개 가능하며, <br> 중복 등록이 불가합니다."
            );
          }
        } catch (err) {
          console.log(err);
          alertify.error("북마크 과정에서 문제가 생겼습니다.");
        }
      }

      async function houseList() {
        let sido = document.querySelector("#sido").value;
        if (sido == null) sido = "서울특별시";
        let gugun = document.querySelector("#gugun").value;
        if (gugun == null) gugun = "종로구";

        let urlParmas = new URLSearchParams({
          sido,
          gugun,
          limit: LIST_ROW_COUNT,
          offset: OFFSET,
        });

        let fetchOptions = {
          method: "POST",
          body: urlParmas,
        };

        try {
          let response = await fetch("/houses", fetchOptions);
          let data = await response.json();
          console.log(data);
          if (data.result == SUCCESS) {
            makeListHtml(data.list);
          } else {
            alertify.error("글 조회 오류");
          }
        } catch (error) {
          alertify.error("글 조회 오류");
        }
      }

      function makeListHtml(list) {
        let listHtml = ``;
        list.forEach((el) => {
          let houseSeq = el.no;
          let sido = el.sido;
          let gugun = el.gugun;
          let dong = el.dong;
          let aptName = el.aptName;
          let floor = el.floor;
          let area = el.area;
          let dealAmount = el.dealAmount;

          listHtml += `
		                  <tr style="cursor:pointer;" data-no="${houseSeq}">
		                      <th scope="row">${houseSeq}</th>
		                      <td>${sido}</td>
		                      <td>${gugun}</td>
		                      <td>${dong}</td>
		                      <td>${aptName}</td>
		                      <td>${floor}</td>
		                      <td>${area}</td>
		                      <td>${dealAmount}</td>
		                  </tr>
		              `;
        });

        document.querySelector("#aptTbody").innerHTML = listHtml;

        makeListHtmlEventHandler();
        houseListTotalCnt();
      }

      async function makeListHtmlEventHandler() {
        document.querySelectorAll("#aptTbody tr").forEach((el) => {
          el.onclick = function () {
            let houseSeq = this.getAttribute("data-no");
            houseDetail(houseSeq);
          };
        });
      }

      async function houseDetail(houseSeq) {
        let url = "/houses/";
        let urlParams = houseSeq;
        console.log(houseSeq);

        let fetchOptions = {
          method: "GET",
        };

        try {
          let res = await fetch(url + urlParams, fetchOptions);
          let data = await res.json();
          makeDetailHtml(data);
        } catch (err) {
          console.log(err);
          alertify.error("실거래가 조회 과정에서 문제가 생겼습니다.");
        }
      }

      async function makeDetailHtml(detail) {
        let houseSeq = detail.no;
        let sido = detail.sido;
        let gugun = detail.gugun;
        let dong = detail.dong;
        let aptName = detail.aptName;
        let floor = detail.floor;
        let area = detail.area;
        let dealAmount = detail.dealAmount;
        let buildYear = detail.buildYear;
        let dealYear = detail.dealYear;
        let dealMonth = detail.dealMonth;

        document.querySelector("#houseDetailModal").setAttribute("data-no", houseSeq);
        document.querySelector("#houseSeqDetail").innerHTML = houseSeq;
        document.querySelector("#dongDetail").innerHTML = dong;
        document.querySelector("#gugunDetail").innerHTML = gugun;
        document.querySelector("#sidoDetail").innerHTML = sido;
        document.querySelector("#aptNameDetail").innerHTML = aptName;
        document.querySelector("#floorDetail").innerHTML = floor;
        document.querySelector("#areaDetail").innerHTML = area;
        document.querySelector("#dealAmountDetail").innerHTML = dealAmount;
        document.querySelector("#buildYearDetail").innerHTML = buildYear;
        document.querySelector("#dealYearDetail").innerHTML = dealYear;
        document.querySelector("#dealMonthDetail").innerHTML = dealMonth;

        let modalDetail = new bootstrap.Modal(document.querySelector("#houseDetailModal"));
        modalDetail.show();
      }

      async function houseListTotalCnt() {
        let url = "/house/houseListTotalCnt";

        let sido = document.querySelector("#sido").value;
        let gugun = document.querySelector("#gugun").value;
        let searchCategory = document.querySelector("#searchCategory").value;
        let searchWord = document.querySelector("#searchWord").value;

        var dong, aptName;
        if (searchCategory == "아파트별") {
          dong = "";
          aptName = searchWord;
        } else if (searchCategory == "동별") {
          dong = searchWord;
          aptName = "";
        } else if (searchCategory == "전체") {
          dong = "";
          aptName = "";
        }

        let urlParams =
          "?sido=" + sido + "&gugun=" + gugun + "&dong=" + dong + "&aptName=" + aptName;

        let fetchOptions = {
          method: "GET",
        };

        try {
          let res = await fetch(url + urlParams, fetchOptions);
          let data = await res.json();
          TOTAL_LIST_ITEM_COUNT = data.totalCnt;

          makePaginationHtml(
            LIST_ROW_COUNT,
            PAGE_LINK_COUNT,
            CURRENT_PAGE_INDEX,
            TOTAL_LIST_ITEM_COUNT,
            "paginationWrapper"
          );
        } catch (err) {
          console.log(err);
          alertify.error("실거래가 조회 과정에서 문제가 생겼습니다.");
        }
      }

      async function houseSearch() {
        let sido = document.querySelector("#sido").value;
        let gugun = document.querySelector("#gugun").value;
        let searchCategory = document.querySelector("#searchCategory").value;
        let searchWord = document.querySelector("#searchWord").value;

        console.log(sido, gugun, searchCategory, searchWord);

        var urlParams;
        if (searchCategory == "아파트별") {
          urlParams =
            "?sido=" +
            sido +
            "&gugun=" +
            gugun +
            "&aptName=" +
            searchWord +
            "&limit=" +
            LIST_ROW_COUNT +
            "&offset=" +
            OFFSET;
          /* 	urlParmas = new URLSearchParams({
					sido,
					gugun,
					dong: "",
					aptName: searchWord,
					limit: LIST_ROW_COUNT,
					offset: OFFSET,
				}); */
        } else if (searchCategory == "동별") {
          urlParams =
            "?sido=" +
            sido +
            "&gugun=" +
            gugun +
            "&dong=" +
            searchWord +
            "&limit=" +
            LIST_ROW_COUNT +
            "&offset=" +
            OFFSET;

          /* urlParmas = new URLSearchParams({
					sido,
					gugun,
					dong: searchWord,
					aptName: "",
					limit: LIST_ROW_COUNT,
					offset: OFFSET,
				}); */
        } else if (searchCategory == "전체") {
          urlParams =
            "?sido=" +
            sido +
            "&gugun=" +
            gugun +
            "&dong=" +
            searchWord +
            "&aptName=" +
            searchWord +
            "&limit=" +
            LIST_ROW_COUNT +
            "&offset=" +
            OFFSET;

          /* urlParmas = new URLSearchParams({
					sido,
					gugun,
					dong: searchWord,
					aptName: searchWord,
					limit: LIST_ROW_COUNT,
					offset: OFFSET,
				}); */
        }

        let fetchOptions = {
          method: "GET",
        };
        try {
          let response = await fetch("/houses/search" + urlParams, fetchOptions);
          let data = await response.json();
          if (data.result == SUCCESS) {
            makeListHtml(data.list);
          } else {
            alertify.error("실거래 조회에서 문제가 생겼습니다.");
          }
        } catch (err) {
          console.log(err);
          alertify.error("실거래 조회에서 문제가 생겼습니다.");
        }
      }

      function movePage(pageIndex) {
        OFFSET = (pageIndex - 1) * LIST_ROW_COUNT;
        CURRENT_PAGE_INDEX = pageIndex;
        houseList();
      }
    </script>
  </body>
</html>
