<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Event Management</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
      integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
      integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF"
      crossorigin="anonymous"
    ></script>

    <!-- JavaScript -->
    <script src="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/alertify.min.js"></script>

    <!-- CSS -->
    <link
      rel="stylesheet"
      href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/alertify.min.css"
    />
    <!-- Default theme -->
    <link
      rel="stylesheet"
      href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/themes/default.min.css"
    />
    <!-- Semantic UI theme -->
    <link
      rel="stylesheet"
      href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/themes/semantic.min.css"
    />
    <!-- Bootstrap theme -->
    <link
      rel="stylesheet"
      href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/themes/bootstrap.min.css"
    />

    <style>
      #topContainer {
        margin-top: 150px;
      }

      .page-link {
        color: #000;
        background-color: #fff;
        border: 1px solid #ccc;
      }

      .page-item.active .page-link {
        z-index: 1;
        color: white;
        font-weight: bold;
        background-color: #212529 !important;
        border-color: #212529 !important;
      }

      .page-link:focus,
      .page-link:hover {
        color: #000;
        background-color: #fafafa;
        border-color: #ccc;
      }
    </style>
  </head>

  <body>
    <div id="topContainer" class="container">
<!--       <%-- nav bar --%> <%@ include file="./login.jsp"%> -->
      <h4 class="text-center mt-4">이벤트 관리</h4>

      <!-- 테이블 -->
      <table class="table table-hover">
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">제목</th>
            <th scope="col">시작 일시</th>
            <th scope="col">종료 일시</th>
            <th scope="col">상태</th>
          </tr>
        </thead>
        <tbody id="eventTbody"></tbody>
      </table>

      <!-- 페이지네이션 -->
      <nav id="paginationWrapper" class="mt-4"></nav>

      <button class="btn btn-dark" type="button" id="btnInsertPage">이벤트 등록</button>

      <!-- Modal Insert -->
      <div
        class="modal fade"
        id="eventInsertModal"
        tabindex="-1"
        aria-labelledby="exampleModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-xl">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">이벤트 등록</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="titleInsert" class="form-label">제목</label>
                <input type="text" class="form-control" id="titleInsert" />
              </div>

              <div class="mb-3">
                <label for="startInsert" class="form-label">시작 일시</label>
                <input type="date" class="form-control" id="startInsert" />
              </div>

              <div class="mb-3">
                <label for="endInsert" class="form-label">종료 일시</label>
                <input type="date" class="form-control" id="endInsert" />
              </div>

              <div class="mb-3">
                <label for="urlInsert" class="form-label">html URL</label>
                <input type="text" class="form-control" id="urlInsert" />
              </div>

              <button id="btnEventInsert" type="button" class="btn btn-outline-success float-end">
                등록
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Detail -->
      <div
        class="modal fade"
        id="eventDetailModal"
        tabindex="-1"
        aria-labelledby="exampleModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-xl">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">글 상세</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <table class="table table-hover">
                <tbody>
                  <tr>
                    <td>이벤트 번호</td>
                    <td id="eventKeyDetail">#</td>
                  </tr>
                  <tr>
                    <td>제목</td>
                    <td id="titleDetail">#</td>
                  </tr>
                  <tr>
                    <td>작성자</td>
                    <td id="userNameDetail">#</td>
                  </tr>
                  <tr>
                    <td>작성 일시</td>
                    <td id="regDtDetail">#</td>
                  </tr>
                  <tr>
                    <td>시작 일시</td>
                    <td id="startDtDetail">#</td>
                  </tr>
                  <tr>
                    <td>종료 일시</td>
                    <td id="endDtDetail">#</td>
                  </tr>
                  <tr>
                    <td>html URL</td>
                    <td id="urlDetail">#</td>
                  </tr>
                  <tr>
                    <td>상태</td>
                    <td id="statusDetail">#</td>
                  </tr>
                </tbody>
              </table>
              <button id="btnEventUpdateForm" type="button" class="btn btn-sm btn-outline-success">
                수정하기
              </button>
              <button
                id="btnEventDeleteConfirm"
                type="button"
                class="btn btn-sm btn-outline-danger"
              >
                삭제하기
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Update -->
      <div
        class="modal fade"
        id="eventUpdateModal"
        tabindex="-1"
        aria-labelledby="exampleModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-xl">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">글 수정하기</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="titleUpdate" class="form-label">제목</label>
                <input type="text" class="form-control" id="titleUpdate" />
              </div>
              <div class="mb-3">
                <label for="startUpdate" class="form-label">시작 일시</label>
                <input type="date" class="form-control" id="startUpdate" />
              </div>
              <div class="mb-3">
                <label for="endUpdate" class="form-label">종료 일시</label>
                <input type="date" class="form-control" id="endUpdate" />
              </div>
              <div class="mb-3">
                <label for="urlUpdate" class="form-label">html URL</label>
                <input type="text" class="form-control" id="urlUpdate" />
              </div>
              <div class="mb-3">
                <label for="statusUpdate" class="form-label">진행 상태</label>
                <div class="radioBtn">
                  <input type="radio" name="status" value="0" autocomplete="off" />이벤트 종료
                  <input type="radio" name="status" value="1" autocomplete="off" />진행 중
                </div>
              </div>

              <button id="btnEventUpdate" type="button" class="btn btn-outline-success float-end">
                수정
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

<!--     <% String userCode = userDto.getCode(); %> <% int userSeq = userDto.getUserSeq(); %> -->

    <script src="/js/util.js"></script>
    <script>
//       if ("<%= userCode %>" == "001") {
//         document.querySelector("#btnInsertPage").style.display = "block";
//       } else {
//         document.querySelector("#btnInsertPage").style.display = "none";
//       }

      var OFFSET = 0;

      // pagination
      var LIST_ROW_COUNT = 10; // limit
      var PAGE_LINK_COUNT = 10; // pagination link 개수
      var CURRENT_PAGE_INDEX = 1;
      var TOTAL_LIST_ITEM_COUNT = 0; // 총 건수

      window.onload = function () {
        eventList();

        // insert page
        document.querySelector("#btnInsertPage").onclick = function () {
          document.querySelector("#titleInsert").value = "";

          let modal = new bootstrap.Modal(
            document.querySelector("#eventInsertModal")
          );

          modal.show();
        };

        // insert
        document.querySelector("#btnEventInsert").onclick = function () {
          if (validateInsert()) {
            eventInsert();
          } else {
            alertify.error("입력을 확인해 주세요. ");
          }
        };

        // update
        document.querySelector("#btnEventUpdateForm").onclick = function () {
          // detail => update 글 상세 내용을 복사 ( key인 eventKey 를 복사 포함 )
          // detail modal 닫고 upate modal을 띄운다.

          let eventKey = document
            .querySelector("#eventDetailModal")
            .getAttribute("data-eventKey");

          document
            .querySelector("#eventUpdateModal")
            .setAttribute("data-eventKey", eventKey);

          document.querySelector("#titleUpdate").value =
            document.querySelector("#titleDetail").innerHTML;

          document.querySelector("#startUpdate").value =
            document.querySelector("#startDtDetail").innerHTML;

          document.querySelector("#endUpdate").value =
            document.querySelector("#endDtDetail").innerHTML;

          document.querySelector("#urlUpdate").value =
            document.querySelector("#urlDetail").innerHTML;

          // document.querySelector("#statusUpdate").value =
          //   document.querySelector("#statusDetail").innerHTML;

          let modalDetail = new bootstrap.Modal(
            document.querySelector("#eventDetailModal")
          );
          modalDetail.hide();

          let modalUpdate = new bootstrap.Modal(
            document.querySelector("#eventUpdateModal")
          );
          modalUpdate.show();
        };

        document.querySelector("#btnEventUpdate").onclick = function () {
          if (validateUpdate()) {
            eventUpdate();
          } else {
            alertify.error("입력을 확인해 주세요. ");
          }
        };

        // delete
        document.querySelector("#btnEventDeleteConfirm").onclick = function () {
          alertify.confirm(
            "삭제 확인",
            "글을 삭제하시겠습니까?",
            function () {
              eventDelete();
            },
            function () {
              console.log("user cancel");
            }
          );
        };

        // logout
        document.querySelector("#btnLogout").onclick = function () {
          logout();
        };
      };

      // GET 방식
      async function eventList() {
        let url = "/event/eventList";
        let urlParams = "?limit=" + LIST_ROW_COUNT + "&offset=" + OFFSET;
        let fetchOptions = {
          method: "GET",
        };

        try {
          let response = await fetch(url + urlParams, fetchOptions);
          let data = await response.json();
          console.log(data);
          makeListHtml(data);
        } catch (error) {
          console.log(error);
          alertify.error("글 조회 과정에서 문제가 생겼습니다. ");
        }
      }

      function makeListHtml(list) {
        let listHtml = ``;
        list.forEach((el) => {
          let eventKey = el.eventKey;
          let eventName = el.eventName;
          let startDate = el.startDate;
          let endDate = el.endDate;
          let statusCode = el.statusCode;
          let strStatus = statusCode == 1 ? "진행 중" : "종료";

          listHtml += `<tr style = "cursor:pointer"; data-eventKey = \${eventKey}>
                       <td>\${eventKey}</td>
                       <td>\${eventName}</td>
                       <td>\${startDate}</td>
                       <td>\${endDate}</td>
                       <td>\${strStatus}</td>
                    </tr>`;
        });

        document.querySelector("#eventTbody").innerHTML = listHtml;

        makeListHtmlEventHandler();

        eventListTotalCnt();
      }

      function makeListHtmlEventHandler() {
        document.querySelectorAll("#eventTbody tr").forEach((el) => {
          el.onclick = function () {
            let eventKey = this.getAttribute("data-eventKey");
            eventDetail(eventKey);
          };
        });
      }

      // GET 방식
      async function eventListTotalCnt() {
        let url = "/event/eventListTotalCnt";

        let fetchOptions = {
          method: "GET",
        };

        try {
          let response = await fetch(url, fetchOptions);
          let data = await response.json();
          console.log(data);
          TOTAL_LIST_ITEM_COUNT = data.totalCnt;
          makePaginationHtml(
            LIST_ROW_COUNT,
            PAGE_LINK_COUNT,
            CURRENT_PAGE_INDEX,
            TOTAL_LIST_ITEM_COUNT,
            "paginationWrapper"
          );
        } catch (error) {
          console.log(error);
          alertify.error("글 조회 과정에서 문제가 생겼습니다. ");
        }
      }

      function movePage(pageIndex) {
        OFFSET = (pageIndex - 1) * LIST_ROW_COUNT;
        CURRENT_PAGE_INDEX = pageIndex;
        eventList();
      }

      // GET 방식
      async function eventDetail(eventKey) {
        let url = "/event/eventDetail";
        let urlParams = "?eventKey=" + eventKey;

        let fetchOptions = {
          method: "GET",
        };

        try {
          let response = await fetch(url + urlParams, fetchOptions);
          let data = await response.json();
          console.log(data);
          makeDetailHtml(data);
        } catch (error) {
          console.log(error);
          alertify.error("글 조회 과정에서 문제가 생겼습니다. ");
        }
      }

      function makeDetailHtml(detail) {
        let eventKey = detail.eventKey;
        let eventName = detail.eventName;
        let userName = detail.userName;
        let regDt = detail.regDt;
        let regDtStr =
          makeDateStr(regDt.date.year, regDt.date.month, regDt.date.day, ".") +
          " " +
          makeTimeStr(
            regDt.time.hour,
            regDt.time.minute,
            regDt.time.second,
            ":"
          );
        let startDate = detail.startDate;
        let endDate = detail.endDate;
        let htmlUrl = detail.htmlUrl;
        let statusCode = detail.statusCode;
        let strStatus = statusCode == 1 ? "진행 중" : "종료";

        let adminUser = detail.adminUser;

        document
          .querySelector("#eventDetailModal")
          .setAttribute("data-eventKey", eventKey);
        document.querySelector("#eventKeyDetail").innerHTML = eventKey;
        document.querySelector("#titleDetail").innerHTML = eventName;
        document.querySelector("#userNameDetail").innerHTML = userName;
        document.querySelector("#regDtDetail").innerHTML = regDtStr;
        document.querySelector("#startDtDetail").innerHTML = startDate;
        document.querySelector("#endDtDetail").innerHTML = endDate;
        document.querySelector("#urlDetail").innerHTML = htmlUrl;
        document.querySelector("#statusDetail").innerHTML = strStatus;

        if (adminUser) {
          document.querySelector("#btnEventUpdateForm").style.display =
            "inline-block";
          document.querySelector("#btnEventDeleteConfirm").style.display =
            "inline-block";
        } else {
          document.querySelector("#btnEventUpdateForm").style.display = "none";
          document.querySelector("#btnEventDeleteConfirm").style.display =
            "none";
        }

        let modal = new bootstrap.Modal(
          document.querySelector("#eventDetailModal")
        );

        modal.show();
      }

      ///////////////////////////////////////
      function validateInsert() {
        // return true / false
        let isTitleInsertValid = false;

        let titleInsertValue = document.querySelector("#titleInsert").value;
        if (titleInsertValue.length > 0) {
          isTitleInsertValid = true;
        }

        if (isTitleInsertValid) {
          return true;
        }

        return false;
      }

      async function eventInsert() {
        let eventName = document.querySelector("#titleInsert").value;
        let startDate = document.querySelector("#startInsert").value;
        let endDate = document.querySelector("#endInsert").value;
        let htmlUrl = document.querySelector("#urlInsert").value;

        let urlParams = new URLSearchParams({
          eventName: eventName,
          startDate: startDate,
          endDate: endDate,
          htmlUrl: htmlUrl,
        });

        let fetchOptions = {
          method: "POST",
          body: urlParams,
        };

        let url = "/event/eventInsert";
        try {
          let response = await fetch(url, fetchOptions);
          let data = await response.json();
          if (data.result == "success") {
            alertify.success("글이 등록되었습니다.");
            eventList();
          } else if (data.result == "fail") {
            alertify.error("글 등록 과정에서 오류가 발생했습니다.");
          }
        } catch (error) {
          alertify.error("글 등록 과정에서 오류가 발생했습니다.");
        }
      }

      function validateUpdate() {
        // return true / false
        let isTitleUpdateValid = false;

        let titleUpdateValue = document.querySelector("#titleUpdate").value;
        if (titleUpdateValue.length > 0) {
          isTitleUpdateValid = true;
        }

        if (isTitleUpdateValid) {
          return true;
        }

        return false;
      }

      async function eventUpdate() {
        let eventKey = document
          .querySelector("#eventUpdateModal")
          .getAttribute("data-eventKey");
        let eventName = document.querySelector("#titleUpdate").value;
        let startDate = document.querySelector("#startUpdate").value;
        let endDate = document.querySelector("#endUpdate").value;
        let htmlUrl = document.querySelector("#urlUpdate").value;
        let statusCode = "";

        const nodeList = document.getElementsByName("status");
        nodeList.forEach((node) => {
          if (node.checked) {
            statusCode = node.value;
          }
        });

//         let userSeq = <%=userSeq%>;

        let urlParams = new URLSearchParams({
          eventName: eventName,
          startDate: startDate,
          endDate: endDate,
          htmlUrl: htmlUrl,
          statusCode: statusCode,
          userSeq: userSeq,
          eventKey: eventKey,
        });

        let fetchOptions = {
          method: "POST",
          body: urlParams,
        };

        try {
          let response = await fetch(
            "/event/eventUpdate",
            fetchOptions
          );
          let data = await response.json();
          if (data.result == "success") {
            alertify.success("글이 수정되었습니다. ");
          } else if (data.result == "fail") {
            alertify.error("수정 과정에서 오류가 발생했습니다. ");
          }
        } catch (error) {
          alertify.error("수정 과정에서 오류가 발생했습니다. ");
        }
      }

      // 삭제 함수
      async function eventDelete() {
        let eventKey = document
          .querySelector("#eventDetailModal")
          .getAttribute("data-eventKey");

        let url = "/event/eventDelete";
        let urlParams = "?eventKey=" + eventKey;

        try {
          let response = await fetch(url + urlParams);
          let data = await response.json();
          if (data.result == "success") {
            alertify.success("글이 삭제되었습니다. ");
          } else if (data.result == "fail") {
            alertify.error("글 삭제 과정에서 오류가 발생했습니다. ");
          }
        } catch (error) {
          alertify.error("글 삭제 과정에서 오류가 발생했습니다. ");
        }
      }

      async function logout() {
        let url = "/logout";

        try {
          let response = await fetch(url);
          let data = await response.json();
          if (data.result == "success") {
            window.location.href = "/jsp/login.jsp";
          } else if (data.result == "fail") {
            alertify.error("로그아웃 과정에서 오류가 발생했습니다. ");
          }
        } catch (error) {
          alertify.error("로그아웃 과정에서 오류가 발생했습니다. ");
        }
      }
    </script>
  </body>
</html>
