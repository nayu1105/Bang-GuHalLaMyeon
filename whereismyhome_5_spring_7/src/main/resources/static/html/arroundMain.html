<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>실거래가 조회 메인</title>
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
			rel="stylesheet"
			integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
			crossorigin="anonymous"
		/>
		<script
			src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
			integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
			crossorigin="anonymous"
		></script>

		<!-- JavaScript -->
		<script src="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/alertify.min.js"></script>

		<!-- CSS -->
		<link
			rel="stylesheet"
			href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/alertify.min.css"
		/>
		<!-- Default theme -->
		<link
			rel="stylesheet"
			href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/themes/default.min.css"
		/>
		<!-- Semantic UI theme -->
		<link
			rel="stylesheet"
			href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/themes/semantic.min.css"
		/>
		<!-- Bootstrap theme -->
		<link
			rel="stylesheet"
			href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/themes/bootstrap.min.css"
		/>

		<style>
			#topContainer {
				margin-top: 150px;
			}

			.page-link {
				color: #000;
				background-color: #fff;
				border: 1px solid #ccc;
			}

			.page-item.active .page-link {
				z-index: 1;
				color: white;
				font-weight: bold;
				background-color: #212529 !important;
				border-color: #212529 !important;
			}

			.page-link:focus,
			.page-link:hover {
				color: #000;
				background-color: #fafafa;
				border-color: #ccc;
			}
		</style>
	</head>
	<div id="topContainer" class="container">
<!-- 		<%-- nav bar --%> <%@ include file="./login.jsp"%> -->
		<h4 class="text-center mt-4">주변 업종</h4>

		<!-- 검색 -->
		<div class="input-group mb-3 mt-4">
			<select class="form-select" id="sido" aria-label="Default select example">
				<option selected value="">전체</option>
				<option value="11" selected>서울특별시</option>
			</select>
			<select class="form-select" id="gugun" aria-label="Default select example">
				<option value="">전체</option>
<!-- 				<%-- <option value="11">종로구</option> --%> -->
<!-- 				<%-- <option value="12">중구</option> --%> -->
			</select>
		</div>

		
<!-- 		<%-- <button class="btn btn-dark" type="button" id="btnArroundCharge">전기차조회</button> --%> -->
<!-- 		<%-- <button class="btn btn-dark" type="button" id="btnArroundAgency">부동산중개업소조회</button> --%> -->

		<!-- 테이블 -->
		<table class="table table-hover">
			<thead>
				<tr>
					<th scope="col">#</th>
					<th scope="col">부동산 상호명</th>
					<th scope="col">주소</th>
					<th scope="col">중개업자</th>
					<th scope="col">번호</th>
				</tr>
			</thead>
			<tbody id="agencyTbody"></tbody>
		</table>

		<!-- 페이지네이션 -->
		<nav id="paginationWrapper" class="mt-4"></nav>

		<!-- Board Detail Modal -->
		<div
			class="modal fade"
			id="agencyDetailModal"
			tabindex="-1"
			aria-labelledby="exampleModalLabel"
			aria-hidden="true"
		>
			<div class="modal-dialog modal-dialog-centered modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="exampleModalLabel">부동산 중개업소 상세조회</h5>
						<button
							type="button"
							class="btn-close"
							data-bs-dismiss="modal"
							aria-label="Close"
						></button>
					</div>
					<div class="modal-body">
						<table class="table table-hover" style="cursor: default;">
							<tbody>
								<tr>
									<td>글 번호</td>
									<td id="agencyIdDetail">#</td>
								</tr>
								<tr>
									<td>시도</td>
									<td id="sidoDetail">#</td>
								</tr>
								<tr>
									<td>구군</td>
									<td id="gugunDetail">#</td>
								</tr>
								<tr>
									<td>동</td>
									<td id="dongDetail">#</td>
								</tr>
								<tr>
									<td>주소</td>
									<td id="agencyAddressDetail">#</td>
								</tr>
								<tr>
									<td>중개업자</td>
									<td id="agentDetail">#</td>
								</tr>
								<tr>
									<td>상호명</td>
									<td id="agencyNameDetail">#</td>
								</tr>
								<tr>
									<td>전화번호</td>
									<td id="agencyPhoneDetail">#</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script src="/js/util.js"></script>
	<script>
		var OFFSET = 0; // offset
		var SEARCH_WORD = ""; // 검색어

		// Pagination
		var LIST_ROW_COUNT = 10; // limit, 한 페이지 내에 보여주는 글의 개수
		var PAGE_LINK_COUNT = 10; // 페이지 링크를 몇 개 만들 것인가. 그 밑에 10개 이렇게 있는거
		var CURRENT_PAGE_INDEX = 1; // 현재 페이지 인덱스
		var TOTAL_LIST_ITEM_COUNT = 0; // 총 아이템 건 수

		window.onload = () => {
			agencyList();

			document.querySelector("#gugun").onchange = () => {
				agencyList();
			};
		};

		async function agencyList() {
			let sido = document.querySelector("#sido").value;
			let gugun = document.querySelector("#gugun").value;

			let url = "/arround/agencyList";
			let urlParams = "?code=" + sido + gugun;

			let fetchOptions = {
				method: "GET",
			};

			try {
				let res = await fetch(url + urlParams, fetchOptions);
				let data = await res.json();
				console.log(data);
				makeListHtml(data);
			} catch (err) {
				console.log(err);
				alertify.error("실거래가 조회 과정에서 문제가 생겼습니다.");
			}
		}

		function makeListHtml(list) {
			let listHtml = ``;
			list.forEach((el) => {
				let agencyId = el.code;
				let agencyName = el.agencyName;
				let agencyAddress = el.address;
				let agent = el.agent;
				let agencyPhone = el.tel;

				listHtml += `
		                  <tr style="cursor:pointer;" data-agencyId="\${agencyId}">
		                      <th scope="row">\${agencyId}</th>
		                      <td>\${agencyName}</td>
		                      <td>\${agencyAddress}</td>
		                      <td>\${agent}</td>
		                      <td>\${agencyPhone}</td>
		                  </tr>
		              `;
			});

			document.querySelector("#agencyTbody").innerHTML = listHtml;

			makeListHtmlEventHandler();
			agencyListTotalCnt();
		}

		async function makeListHtmlEventHandler() {
			document.querySelectorAll("#agencyTbody tr").forEach((el) => {
				el.onclick = function () {
					let agencyId = this.getAttribute("data-agencyId");
					console.log(agencyId);
					agencyDetail(agencyId);
				};
			});
		}

		async function agencyDetail(agencyId) {
			let url = "/arround/agencyDetail";
			let urlParams = "?agencyId=" + agencyId;

			let fetchOptions = {
				method: "GET",
			};

			try {
				let res = await fetch(url + urlParams, fetchOptions);
				let data = await res.json();
				makeDetailHtml(data);
			} catch (err) {
				console.log(err);
				alertify.error("실거래가 조회 과정에서 문제가 생겼습니다.");
			}
		}

		async function makeDetailHtml(detail) {
			let agencyId = detail.agencyId;
			let sido = detail.sido;
			let gugun = detail.gugun;
			let dong = detail.dong;
			let agencyAddress = detail.agencyAddress;
			let agent = detail.agent;
			let agencyName = detail.agencyName;
			let agencyPhone = detail.agencyPhone;

			document.querySelector("#agencyDetailModal").setAttribute("data-agencyId", agencyId);
			document.querySelector("#agencyIdDetail").innerHTML = agencyId;
			document.querySelector("#dongDetail").innerHTML = dong;
			document.querySelector("#gugunDetail").innerHTML = gugun;
			document.querySelector("#sidoDetail").innerHTML = sido;
			document.querySelector("#agencyAddressDetail").innerHTML = agencyAddress;
			document.querySelector("#agentDetail").innerHTML = agent;
			document.querySelector("#agencyNameDetail").innerHTML = agencyName;
			document.querySelector("#agencyPhoneDetail").innerHTML = agencyPhone;

			let modalDetail = new bootstrap.Modal(document.querySelector("#agencyDetailModal"));
			modalDetail.show();
		}

		async function agencyListTotalCnt() {
			let url = "/arround/agencyListTotalCnt";

			let fetchOptions = {
				method: "GET",
			};

			try {
				let res = await fetch(url, fetchOptions);
				let data = await res.json();
				TOTAL_LIST_ITEM_COUNT = 100;

				makePaginationHtml(
					LIST_ROW_COUNT,
					PAGE_LINK_COUNT,
					CURRENT_PAGE_INDEX,
					TOTAL_LIST_ITEM_COUNT,
					"paginationWrapper"
				);
			} catch (err) {
				console.log(err);
				alertify.error("실거래가 조회 과정에서 문제가 생겼습니다.");
			}
		}


		function movePage(pageIndex) {
			OFFSET = (pageIndex - 1) * LIST_ROW_COUNT;
			CURRENT_PAGE_INDEX = pageIndex;
			agencyList();
		}
	</script>
</html>
